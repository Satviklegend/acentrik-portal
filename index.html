<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acentrik Consultancy | Employee Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --acentrik-blue: #1a3a8f;
            --acentrik-light: #2d55cc;
            --acentrik-gold: #d4af37;
            --light-bg: #f5f7ff;
            --dark-text: #333;
            --light-text: #666;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 8px;
            --success: #2ecc71;
            --error: #e74c3c;
            --warning: #f39c12;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Login Page Styles */
        .login-container {
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--acentrik-blue) 0%, var(--acentrik-light) 100%);
        }
        
        .login-box {
            background-color: var(--white);
            border-radius: var(--radius);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            color: var(--acentrik-blue);
        }
        
        .login-logo i {
            font-size: 2.5rem;
            color: var(--acentrik-gold);
        }
        
        .login-logo h1 {
            font-size: 1.8rem;
        }
        
        .login-title {
            color: var(--acentrik-blue);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }
        
        .login-subtitle {
            color: var(--light-text);
            margin-bottom: 30px;
        }
        
        .login-form {
            text-align: left;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-text);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--acentrik-light);
            box-shadow: 0 0 0 2px rgba(45, 85, 204, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--acentrik-blue);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            background-color: var(--acentrik-light);
        }
        
        .btn-secondary {
            background-color: #f8f9fa;
            color: var(--dark-text);
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover {
            background-color: #e9ecef;
        }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 25px 0;
            color: var(--light-text);
        }
        
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #eee;
        }
        
        .divider span {
            padding: 0 15px;
            font-size: 0.9rem;
        }
        
        .forgot-password {
            text-align: center;
            margin-top: 15px;
        }
        
        .forgot-password a {
            color: var(--acentrik-light);
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .forgot-password a:hover {
            text-decoration: underline;
        }
        
        .alert {
            padding: 12px 15px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background-color: rgba(46, 204, 113, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .alert-error {
            background-color: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }
        
        .alert-warning {
            background-color: rgba(243, 156, 18, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }
        
        /* Employee Portal Container (hidden initially) */
        .portal-container {
            display: none;
        }
        
        /* Portal Header with User Info */
        .portal-header {
            background-color: var(--acentrik-blue);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--acentrik-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: 600;
        }
        
        .user-role {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .logout-btn {
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Rest of your existing portal styles... */
        /* Copy all your existing portal CSS here */
        /* I'll show the key additions first, then you can merge */
        
        .container {
            display: flex;
            min-height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 250px;
            background-color: var(--acentrik-blue);
            color: var(--white);
            padding: 25px 0;
            height: 100%;
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        /* ... ALL YOUR EXISTING PORTAL CSS ... */
        /* Make sure to include all your existing CSS from the previous version */
        
        /* Modal for password reset */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            color: var(--acentrik-blue);
            font-size: 1.3rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }
        
        /* Loading Spinner */
        .spinner {
            display: none;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-loading {
            position: relative;
            color: transparent;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
    </style>
    
    <!-- ALL YOUR EXISTING PORTAL HTML -->
    <!-- We'll wrap it in a container that shows only after login -->
</head>
<body>
    <!-- Login Page (Shown First) -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-chart-network"></i>
                <h1>Acentrik</h1>
            </div>
            
            <h2 class="login-title">Employee Portal</h2>
            <p class="login-subtitle">Sign in to access your dashboard</p>
            
            <!-- Alert Messages -->
            <div id="loginAlert" class="alert alert-error" style="display: none;"></div>
            <div id="successAlert" class="alert alert-success" style="display: none;"></div>
            
            <!-- Login Form -->
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="loginEmail">Company Email</label>
                    <input type="email" id="loginEmail" class="form-control" 
                           placeholder="employee@acentrik.com" required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" 
                           placeholder="Enter your password" required>
                </div>
                
                <button type="submit" id="loginButton" class="login-btn">
                    <span>Sign In</span>
                    <div class="spinner" id="loginSpinner"></div>
                </button>
                
                <div class="forgot-password">
                    <a href="#" id="forgotPasswordLink">Forgot your password?</a>
                </div>
            </form>
            
            <div class="divider">
                <span>Demo Accounts</span>
            </div>
            
            <!-- Demo Login Buttons -->
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="login-btn btn-secondary" id="demoAdminBtn">
                    <i class="fas fa-user-shield"></i> Login as Admin
                </button>
                <button class="login-btn btn-secondary" id="demoEmployeeBtn">
                    <i class="fas fa-user-tie"></i> Login as Employee
                </button>
                <button class="login-btn btn-secondary" id="demoHRBtn">
                    <i class="fas fa-users"></i> Login as HR Manager
                </button>
            </div>
            
            <!-- Password Reset Modal -->
            <div id="resetModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Reset Password</h3>
                        <button class="close-modal" id="closeModal">&times;</button>
                    </div>
                    <div id="resetAlert" class="alert" style="display: none;"></div>
                    <form id="resetForm">
                        <div class="form-group">
                            <label for="resetEmail">Enter your email address</label>
                            <input type="email" id="resetEmail" class="form-control" 
                                   placeholder="employee@acentrik.com" required>
                        </div>
                        <button type="submit" id="resetButton" class="login-btn">
                            Send Reset Link
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Portal Container (Hidden until login) -->
    <div id="portalContainer" class="portal-container">
        <!-- Portal Header with User Info -->
        <div class="portal-header">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-chart-network"></i>
                    <span>Acentrik Employee Portal</span>
                </div>
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">AJ</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Alex Johnson</div>
                    <div class="user-role" id="userRole">Senior Consultant</div>
                </div>
                <button class="logout-btn" id="portalLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <!-- Your Existing Portal Content Goes Here -->
        <div class="container">
            <!-- Sidebar Navigation -->
            <div class="sidebar" id="sidebar">
                <div class="employee-info">
                    <div class="employee-avatar" id="sidebarAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="employee-name" id="sidebarName">Alex Johnson</div>
                    <div class="employee-role" id="sidebarRole">Senior Consultant</div>
                    <div class="employee-id" id="sidebarId">EMP-ACS-2023-087</div>
                </div>
                
                <div class="sidebar-menu">
                    <div class="menu-item active" data-target="dashboard">
                        <div class="menu-icon"><i class="fas fa-home"></i></div>
                        <span>Dashboard</span>
                    </div>
                    <div class="menu-item" data-target="profile">
                        <div class="menu-icon"><i class="fas fa-user-circle"></i></div>
                        <span>My Profile</span>
                    </div>
                    <div class="menu-item" data-target="leave">
                        <div class="menu-icon"><i class="fas fa-calendar-alt"></i></div>
                        <span>Leave Management</span>
                    </div>
                    <div class="menu-item" data-target="payroll">
                        <div class="menu-icon"><i class="fas fa-money-check-alt"></i></div>
                        <span>Payroll & Benefits</span>
                    </div>
                    <div class="menu-item" data-target="projects">
                        <div class="menu-icon"><i class="fas fa-project-diagram"></i></div>
                        <span>My Projects</span>
                    </div>
                    <div class="menu-item" data-target="training">
                        <div class="menu-icon"><i class="fas fa-graduation-cap"></i></div>
                        <span>Training & Development</span>
                    </div>
                    <div class="menu-item" data-target="documents">
                        <div class="menu-icon"><i class="fas fa-folder"></i></div>
                        <span>Documents</span>
                    </div>
                    <div class="menu-item" data-target="directory">
                        <div class="menu-icon"><i class="fas fa-address-book"></i></div>
                        <span>Employee Directory</span>
                    </div>
                    <div class="menu-item" data-target="news">
                        <div class="menu-icon"><i class="fas fa-newspaper"></i></div>
                        <span>Company News</span>
                    </div>
                    
                    <!-- Admin Panel (Visible only for admin users) -->
                    <div class="menu-item admin-only" data-target="admin" style="display: none;">
                        <div class="menu-icon"><i class="fas fa-cogs"></i></div>
                        <span>Admin Panel</span>
                    </div>
                </div>
                
                <div class="logout-container">
                    <div class="logout-btn" id="sidebarLogoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <!-- Header -->
                <div class="header">
                    <div class="header-title">
                        <h1 id="pageTitle">Employee Dashboard</h1>
                        <p id="welcomeMessage">Welcome to Acentrik Consultancy Services Employee Portal</p>
                    </div>
                    <div class="header-controls">
                        <div class="menu-toggle" id="menuToggle">
                            <i class="fas fa-bars"></i>
                        </div>
                        <div class="search-bar">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" placeholder="Search portal...">
                        </div>
                        <div class="notifications">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">3</span>
                        </div>
                    </div>
                </div>
                
                <!-- Dashboard Content -->
                <div id="dashboard" class="dashboard-content active">
                    <div class="welcome-banner" id="personalizedWelcome">
                        <h2>Welcome back, <span id="welcomeName">Alex</span>!</h2>
                        <p>Here's what's happening at Acentrik today. You have 2 pending tasks and 1 new announcement.</p>
                    </div>
                    
                    <!-- Your existing dashboard content... -->
                    <!-- Copy all your existing portal content here -->
                    <!-- I'll show the key authenticated parts -->
                    
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-icon icon-leave">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="leaveBalance">12</h3>
                                <p>Leave Days Available</p>
                            </div>
                        </div>
                        <!-- ... rest of your existing content ... -->
                    </div>
                    
                    <!-- Admin Panel Content (Visible only for admin) -->
                    <div id="admin" class="content-section">
                        <div class="section-header">
                            <h2>Admin Panel</h2>
                        </div>
                        <div class="admin-content">
                            <h3>User Management</h3>
                            <div id="usersList"></div>
                            <!-- Admin features will be populated here -->
                        </div>
                    </div>
                    
                    <!-- ALL YOUR EXISTING PORTAL SECTIONS GO HERE -->
                    <!-- Make sure to include all your existing HTML content -->
                    
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration and Authentication Script -->
    <script>
        // Firebase Configuration - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyYOUR_API_KEY_HERE",
            authDomain: "acentrik-portal.firebaseapp.com",
            projectId: "acentrik-portal",
            storageBucket: "acentrik-portal.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "1:YOUR_APP_ID:web:YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Demo User Credentials (In production, use Firebase Authentication users)
        const demoUsers = {
            admin: {
                email: "admin@acentrik.com",
                password: "Admin@123",
                name: "Sarah Williams",
                role: "Administrator",
                employeeId: "EMP-ACS-2021-001",
                department: "Administration",
                avatar: "SW",
                permissions: ["admin", "hr", "employee"]
            },
            employee: {
                email: "alex.johnson@acentrik.com",
                password: "Employee@123",
                name: "Alex Johnson",
                role: "Senior Consultant",
                employeeId: "EMP-ACS-2023-087",
                department: "Technology Consulting",
                avatar: "AJ",
                permissions: ["employee"]
            },
            hr: {
                email: "hr@acentrik.com",
                password: "HR@123",
                name: "Robert Chen",
                role: "HR Director",
                employeeId: "EMP-ACS-2020-005",
                department: "Human Resources",
                avatar: "RC",
                permissions: ["hr", "employee"]
            }
        };

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const portalContainer = document.getElementById('portalContainer');
        const loginForm = document.getElementById('loginForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginButton = document.getElementById('loginButton');
        const loginSpinner = document.getElementById('loginSpinner');
        const loginAlert = document.getElementById('loginAlert');
        const successAlert = document.getElementById('successAlert');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const resetModal = document.getElementById('resetModal');
        const closeModal = document.getElementById('closeModal');
        const resetForm = document.getElementById('resetForm');
        const resetEmail = document.getElementById('resetEmail');
        const resetButton = document.getElementById('resetButton');
        const resetAlert = document.getElementById('resetAlert');
        const portalLogoutBtn = document.getElementById('portalLogoutBtn');
        const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');
        const demoAdminBtn = document.getElementById('demoAdminBtn');
        const demoEmployeeBtn = document.getElementById('demoEmployeeBtn');
        const demoHRBtn = document.getElementById('demoHRBtn');

        // User info elements
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userAvatar = document.getElementById('userAvatar');
        const sidebarName = document.getElementById('sidebarName');
        const sidebarRole = document.getElementById('sidebarRole');
        const sidebarId = document.getElementById('sidebarId');
        const sidebarAvatar = document.getElementById('sidebarAvatar');
        const welcomeName = document.getElementById('welcomeName');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const personalizedWelcome = document.getElementById('personalizedWelcome');

        // Current user data
        let currentUser = null;

        // Check authentication state
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                console.log('User is signed in:', user.email);
                // Try to get user data from Firestore
                getUserData(user.uid);
            } else {
                // User is signed out
                console.log('User is signed out');
                showLoginPage();
            }
        });

        // Login Form Submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = loginEmail.value.trim();
            const password = loginPassword.value;
            
            // Validate inputs
            if (!email || !password) {
                showAlert(loginAlert, 'Please enter both email and password', 'error');
                return;
            }
            
            // Validate email domain (optional)
            if (!email.endsWith('@acentrik.com') && !email.endsWith('@acentrikconsultancy.com')) {
                if (!confirm('This email is not from Acentrik domain. Continue anyway?')) {
                    return;
                }
            }
            
            // Show loading state
            showLoading(true);
            
            try {
                // Try Firebase authentication first
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Login successful:', userCredential.user.email);
                
                // Get additional user data from Firestore
                await getUserData(userCredential.user.uid);
                
            } catch (error) {
                console.error('Firebase login error:', error);
                
                // Fallback to demo users for testing
                const demoUser = Object.values(demoUsers).find(user => user.email === email);
                
                if (demoUser && demoUser.password === password) {
                    // Demo user authentication
                    console.log('Demo user login successful:', demoUser.name);
                    currentUser = demoUser;
                    showPortalPage();
                } else {
                    // Authentication failed
                    let errorMessage = 'Invalid email or password';
                    
                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'No account found with this email';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'Incorrect password';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Invalid email address';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'Too many failed attempts. Please try again later';
                            break;
                    }
                    
                    showAlert(loginAlert, errorMessage, 'error');
                }
            } finally {
                showLoading(false);
            }
        });

        // Demo Login Buttons
        demoAdminBtn.addEventListener('click', () => {
            loginEmail.value = demoUsers.admin.email;
            loginPassword.value = demoUsers.admin.password;
            loginForm.dispatchEvent(new Event('submit'));
        });

        demoEmployeeBtn.addEventListener('click', () => {
            loginEmail.value = demoUsers.employee.email;
            loginPassword.value = demoUsers.employee.password;
            loginForm.dispatchEvent(new Event('submit'));
        });

        demoHRBtn.addEventListener('click', () => {
            loginEmail.value = demoUsers.hr.email;
            loginPassword.value = demoUsers.hr.password;
            loginForm.dispatchEvent(new Event('submit'));
        });

        // Forgot Password
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            resetModal.style.display = 'flex';
            resetEmail.value = loginEmail.value || '';
        });

        closeModal.addEventListener('click', () => {
            resetModal.style.display = 'none';
            resetAlert.style.display = 'none';
        });

        resetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = resetEmail.value.trim();
            
            if (!email) {
                showAlert(resetAlert, 'Please enter your email address', 'error');
                return;
            }
            
            try {
                await auth.sendPasswordResetEmail(email);
                showAlert(resetAlert, 'Password reset email sent! Check your inbox.', 'success');
                setTimeout(() => {
                    resetModal.style.display = 'none';
                    resetAlert.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error('Password reset error:', error);
                showAlert(resetAlert, 'Error sending reset email. Please try again.', 'error');
            }
        });

        // Logout
        function setupLogoutButtons() {
            const logoutButtons = [portalLogoutBtn, sidebarLogoutBtn];
            
            logoutButtons.forEach(button => {
                if (button) {
                    button.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to logout?')) {
                            try {
                                await auth.signOut();
                                showLoginPage();
                                showAlert(successAlert, 'You have been logged out successfully', 'success');
                                setTimeout(() => {
                                    successAlert.style.display = 'none';
                                }, 3000);
                            } catch (error) {
                                console.error('Logout error:', error);
                            }
                        }
                    });
                }
            });
        }

        // Get user data from Firestore
        async function getUserData(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (userDoc.exists) {
                    // User data exists in Firestore
                    const userData = userDoc.data();
                    currentUser = {
                        uid: userId,
                        email: userData.email,
                        name: userData.name,
                        role: userData.role,
                        employeeId: userData.employeeId,
                        department: userData.department,
                        avatar: userData.avatar || getInitials(userData.name),
                        permissions: userData.permissions || ['employee']
                    };
                    showPortalPage();
                } else {
                    // User doesn't exist in Firestore, use demo data based on email
                    const user = auth.currentUser;
                    const demoUser = Object.values(demoUsers).find(u => u.email === user.email);
                    
                    if (demoUser) {
                        currentUser = demoUser;
                        showPortalPage();
                        
                        // Create user in Firestore if not exists
                        await db.collection('users').doc(userId).set({
                            email: demoUser.email,
                            name: demoUser.name,
                            role: demoUser.role,
                            employeeId: demoUser.employeeId,
                            department: demoUser.department,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        // No matching user found
                        await auth.signOut();
                        showAlert(loginAlert, 'User account not found', 'error');
                    }
                }
            } catch (error) {
                console.error('Error getting user data:', error);
                // Fallback to demo user if Firestore fails
                const user = auth.currentUser;
                const demoUser = Object.values(demoUsers).find(u => u.email === user.email);
                if (demoUser) {
                    currentUser = demoUser;
                    showPortalPage();
                }
            }
        }

        // Show portal page
        function showPortalPage() {
            if (!currentUser) return;
            
            // Update UI with user data
            updateUserUI();
            
            // Show/hide admin features based on permissions
            toggleAdminFeatures();
            
            // Switch to portal view
            loginPage.style.display = 'none';
            portalContainer.style.display = 'block';
            
            // Setup logout buttons
            setupLogoutButtons();
            
            // Initialize portal navigation
            initializePortalNavigation();
            
            // Show welcome message
            showAlert(successAlert, `Welcome back, ${currentUser.name}!`, 'success');
            setTimeout(() => {
                successAlert.style.display = 'none';
            }, 3000);
        }

        // Show login page
        function showLoginPage() {
            loginPage.style.display = 'flex';
            portalContainer.style.display = 'none';
            currentUser = null;
            loginForm.reset();
        }

        // Update user information in UI
        function updateUserUI() {
            if (!currentUser) return;
            
            // Update user info in header
            userName.textContent = currentUser.name;
            userRole.textContent = currentUser.role;
            userAvatar.textContent = currentUser.avatar;
            
            // Update sidebar info
            sidebarName.textContent = currentUser.name;
            sidebarRole.textContent = currentUser.role;
            sidebarId.textContent = currentUser.employeeId;
            sidebarAvatar.innerHTML = `<i class="fas fa-user"></i>`;
            
            // Update welcome messages
            welcomeName.textContent = currentUser.name.split(' ')[0];
            welcomeMessage.textContent = `Welcome to Acentrik Consultancy Services Employee Portal - ${currentUser.department}`;
            
            // Update personalized welcome
            const welcomeBanner = personalizedWelcome.querySelector('h2');
            welcomeBanner.innerHTML = `Welcome back, <span id="welcomeName">${currentUser.name.split(' ')[0]}</span>!`;
            
            // Update avatar color based on role
            updateAvatarColor();
        }

        // Toggle admin features based on permissions
        function toggleAdminFeatures() {
            const adminItems = document.querySelectorAll('.admin-only');
            const isAdmin = currentUser.permissions.includes('admin');
            const isHR = currentUser.permissions.includes('hr');
            
            adminItems.forEach(item => {
                if (isAdmin || isHR) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Update dashboard stats based on role
            updateDashboardStats();
        }

        // Update dashboard statistics based on user role
        function updateDashboardStats() {
            if (!currentUser) return;
            
            const leaveBalance = document.getElementById('leaveBalance');
            
            // Different leave balances for different roles
            const leaveBalances = {
                'admin': 20,
                'hr': 18,
                'employee': 12
            };
            
            let balance = 12; // Default
            
            if (currentUser.permissions.includes('admin')) {
                balance = leaveBalances.admin;
            } else if (currentUser.permissions.includes('hr')) {
                balance = leaveBalances.hr;
            } else {
                balance = leaveBalances.employee;
            }
            
            if (leaveBalance) {
                leaveBalance.textContent = balance;
            }
        }

        // Update avatar color based on role
        function updateAvatarColor() {
            const avatarElements = [userAvatar];
            
            let color = '#d4af37'; // Default gold
            
            if (currentUser.permissions.includes('admin')) {
                color = '#e74c3c'; // Red for admin
            } else if (currentUser.permissions.includes('hr')) {
                color = '#3498db'; // Blue for HR
            } else {
                color = '#2ecc71'; // Green for employees
            }
            
            avatarElements.forEach(avatar => {
                if (avatar) {
                    avatar.style.backgroundColor = color;
                }
            });
        }

        // Get initials from name
        function getInitials(name) {
            return name.split(' ').map(word => word[0]).join('').toUpperCase();
        }

        // Show loading state
        function showLoading(isLoading) {
            if (isLoading) {
                loginButton.classList.add('btn-loading');
                loginButton.disabled = true;
                loginSpinner.style.display = 'block';
            } else {
                loginButton.classList.remove('btn-loading');
                loginButton.disabled = false;
                loginSpinner.style.display = 'none';
            }
        }

        // Show alert message
        function showAlert(alertElement, message, type) {
            alertElement.textContent = message;
            alertElement.className = `alert alert-${type}`;
            alertElement.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 5000);
        }

        // Initialize portal navigation (from your existing code)
        function initializePortalNavigation() {
            // Your existing navigation code here
            // Copy all your existing JavaScript for portal navigation
            
            // Menu items click handler
            const menuItems = document.querySelectorAll('.menu-item');
            const contentSections = document.querySelectorAll('.content-section, .dashboard-content');
            const pageTitle = document.getElementById('pageTitle');
            const quickLinks = document.querySelectorAll('.quick-link');
            
            // Menu titles mapping
            const menuTitles = {
                'dashboard': 'Employee Dashboard',
                'profile': 'My Profile',
                'leave': 'Leave Management',
                'payroll': 'Payroll & Benefits',
                'projects': 'My Projects',
                'training': 'Training & Development',
                'documents': 'Documents',
                'directory': 'Employee Directory',
                'news': 'Company News & Announcements',
                'admin': 'Admin Panel'
            };
            
            // Function to switch content sections
            function switchContent(targetId) {
                // Hide all content sections
                contentSections.forEach(section => {
                    section.classList.remove('active');
                });
                
                // Remove active class from all menu items
                menuItems.forEach(item => {
                    item.classList.remove('active');
                });
                
                // Show target content section
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // Update page title
                if (menuTitles[targetId]) {
                    pageTitle.textContent = menuTitles[targetId];
                }
                
                // Add active class to clicked menu item
                const activeMenuItem = document.querySelector(`.menu-item[data-target="${targetId}"]`);
                if (activeMenuItem) {
                    activeMenuItem.classList.add('active');
                }
                
                // Close sidebar on mobile after selection
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('active');
                }
            }
            
            // Add click event to menu items
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    switchContent(targetId);
                });
            });
            
            // Initialize with dashboard
            switchContent('dashboard');
            
            // Mobile menu toggle
            document.getElementById('menuToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });
        }

        // Check if user is already logged in on page load
        window.addEventListener('DOMContentLoaded', () => {
            // For demo purposes, auto-login with employee account
            // Remove this in production
            if (window.location.search.includes('demo=true')) {
                loginEmail.value = demoUsers.employee.email;
                loginPassword.value = demoUsers.employee.password;
                loginForm.dispatchEvent(new Event('submit'));
            }
        });
    </script>

    <!-- Your existing portal JavaScript here -->
    <!-- Make sure to include all your existing JavaScript functionality -->
</body>
</html>
